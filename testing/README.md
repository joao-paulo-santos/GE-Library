# Granado Espada IPF Tools - Testing Framework

Modular JavaScript validation framework for Granado Espada IPF tool implementations.

## Overview

This testing framework validates our open-source IPF tools against the original Windows tools (iz.exe, ez.exe, etc.) using hash-based comparison. The framework ensures 100% compatibility without distributing proprietary IPF files.

## Quick Start

### Install Dependencies

```bash
cd testing
npm install
```

### Run Full Test Suite

```bash
npm test
```

This will:
1. Extract all test IPF files (ai.ipf, item_texture.ipf, ui.ipf)
2. Generate hashes from our extraction output
3. Compare with reference hashes from original tools
4. Report validation results

### Run Individual Commands

```bash
# Validate extraction output
npm run validate

# Validate with verbose output
npm run validate:verbose

# Compare pre-existing outputs
npm run compare

# Run extractor only
npm run extract -- test_files/ai.ipf output_dir

# Generate reference hashes (requires original Windows tools)
npm run generate

# Generate reference hashes from original tool extractions
# Note: This saves hashes to test_hashes/tools/extraction/original_hashes.json
```

## Architecture

The testing framework uses a modular architecture with clear separation of concerns:

```
testing/
├── src/
│   ├── infrastructure/          # Core utilities
│   │   ├── hash.js            # Hash calculation
│   │   ├── filesystem.js      # File operations
│   │   ├── executor.js        # Command execution
│   │   ├── logger.js          # Logging
│   │   └── config.js          # Configuration
│   ├── business/              # Business logic
│   │   ├── analysis/          # Directory analysis
│   │   ├── hashing/           # Hash strategies
│   │   ├── comparison/        # Hash comparison
│   │   └── validation/        # Tool validators
│   ├── generation/            # Reference generation
│   │   ├── hash-database.js   # Hash database CRUD
│   │   └── reference-generator.js  # Generate reference hashes
│   ├── presentation/          # User interface
│   │   ├── reporting/         # Output formatting
│   │   └── cli/              # Command-line interface
│   └── cli.js               # Main entry point
├── test_files/               # IPF test files
├── test_hashes/              # Reference hash databases
├── package.json              # npm configuration
└── README.md                # This file
```

## Directory Structure

The testing framework uses a three-directory structure:

### test_hashes/tools/
- **extraction/original_hashes.json**: Reference hashes from original Windows tools (iz.exe + ez.exe)
  - Generated by: `npm run generate`
  - Source: `reference_original/` directory
  - Purpose: Ground truth for validation

- **extraction/our_hashes.json**: Hashes from our Go IPF extractor
  - Generated by: `npm test`
  - Source: `reference_our/` directory (temporary)
  - Purpose: Record our tool's output for regression testing
  - Note: Hashes always preserved, extracted files cleaned unless `--keep` flag used

**Future Scalability:**
As additional tools are implemented (optimization, creation, conversion, addition), the structure will expand:
```
test_hashes/tools/
├── extraction/
│   ├── original_hashes.json
│   └── our_hashes.json
├── optimization/
│   ├── original_hashes.json
│   └── our_hashes.json
├── creation/
│   ├── original_hashes.json
│   └── our_hashes.json
└── conversion/
    ├── original_hashes.json
    └── our_hashes.json
```

### reference_original/
Contains extractions from original Windows tools:
- `small_original/` - ai.ipf extracted by iz.exe + ez.exe
- `medium_original/` - item_texture.ipf extracted by iz.exe + ez.exe
- `large_original/` - ui.ipf extracted by iz.exe + ez.exe

**Purpose**: Source of truth for validation. Regenerated only when re-running original tools.

### reference_our/
Contains extractions from our Go IPF extractor:
- `small_our/` - ai.ipf extracted by our tool
- `medium_our/` - item_texture.ipf extracted by our tool
- `large_our/` - ui.ipf extracted by our tool

**Purpose**: Temporary storage for validation. Files are cleaned up after test runs unless `--keep` flag is used. Hashes are always preserved in `test_hashes/tools/extraction/our_hashes.json`.

## Test Files

The framework validates against three test files:

| Name      | Size   | Files | Strategy |
|-----------|--------|-------|----------|
| ai.ipf    | 4.3K   | 4     | Full hash |
| item_texture.ipf | 191MB | 3,063 | Sampling |
| ui.ipf    | 877MB  | 11,567 | Sampling |

### Hash Strategy Selection

The framework automatically selects the appropriate hash strategy:

- **≤100 files**: Full file-by-file hashing
- **>100 files**: Representative sampling (15 beginning + 15 middle + 15 end)

## Commands

### validate

Validate IPF extraction output against reference hashes.

```bash
npm run validate [options]

Options:
  --verbose, -v      Enable detailed output
  --quiet, -q        Suppress console output
  --help, -h         Show help
```

### compare

Compare pre-existing outputs with reference hashes.

```bash
npm run compare [options]

Options:
  --output, -o <path>         Path to output directory or file
  --test-key, -k <key>       Test file key (small, medium, large)
  --output-map, -m <json>    JSON mapping of test keys to outputs
  --reference, -r <path>     Path to reference hashes file
  --report-json <path>        Save report to JSON file
  --verbose, -v               Enable detailed output
  --help, -h                  Show help
```

### generate

Generate reference hash databases (requires original Windows tools).

```bash
npm run generate [options]

Options:
  --ipf-path, -i <path>     Path to IPF files directory
  --output-dir, -o <path>    Output directory for hash databases
  --verbose, -v              Enable detailed output
  --help, -h                 Show help
```

### extract

Run IPF extractor on a file.

```bash
npm run extract <ipf_file> <output_dir> [options]

Arguments:
  <ipf_file>         Path to IPF file to extract
  <output_dir>       Output directory for extracted files

Options:
  --verbose, -v      Enable detailed output
  --help, -h         Show help
```

### test

Run complete extraction and validation test.

```bash
npm test
# or
npm run test

Options:
  --verbose, -v      Enable detailed output
  --keep              Keep extracted files for debugging (otherwise cleaned up)
  --help, -h         Show help message
```

**Process:**
1. Extract all test IPF files using our Go tool
2. Save hashes to `test_hashes/tools/extraction/our_hashes.json`
3. Compare against reference hashes from original tools
4. Clean up extracted files from `reference_our/` (unless `--keep` flag used)

## Configuration

Configuration is in `src/config.js`:

```javascript
{
    // Paths
    PROJECT_ROOT: '/path/to/ge-library',
    TEST_FILES_DIR: 'testing/test_files',
    TEST_HASHES_DIR: 'testing/test_hashes',
    EXTRACTOR_PATH: 'src/golang/build/ipf-extractor',

    // Hash strategy threshold
    HASH_STRATEGY_THRESHOLD: 100,  // Files count threshold

    // Execution timeouts
    EXECUTION_TIMEOUT: 600000,     // 10 minutes
    EXTRACTOR_TIMEOUT: 600000,

    // Logging
    LOG_LEVEL: 'info',            // debug, info, warn, error
    LOG_SINK: 'console'           // console, file, both
}
```

## Output

### Success Output

```
✓ Validation complete: 3/3 tests passed

=== Test Summary ===
Total test files: 3
Perfect matches: 3
Success rate: 100.0%
```

### Failure Output

```
✗ Validation failed: 1/3 tests failed

=== Test Summary ===
Total test files: 3
Perfect matches: 2
Mismatches: 1
Success rate: 66.7%

Differences:
  - ui.ipf: 3 files mismatched
```

## CI/CD Integration

The framework is designed for CI/CD integration:

```bash
# Silent mode for automated pipelines
npm run validate --quiet

# Generate JSON report for automated testing
npm run compare --report-json validation_report.json --quiet

# Non-zero exit code on any failure
# Exit 0: All tests passed
# Exit 1: Any test failed
```

## For Maintainers

### Regenerating Reference Hashes

To regenerate reference hashes:

1. Ensure original Windows tools are available (iz.exe, ez.exe)
2. Run the generate command:

```bash
npm run generateOriginal --verbose
```

This will:
- Run original tools on all test files
- Generate reference hash databases
- Save to `test_hashes/tools/extraction_hashes.json`

### Adding New Test Files

1. Add IPF file to `test_files/` directory
2. Update `TEST_FILES` configuration in `src/config.js`
3. Generate reference hashes: `npm run generateOriginal`
4. Validate: `npm run test`

## Troubleshooting

### Binary Not Found

```
Error: IPF file not found
```

**Solution**: Ensure the Go binary is built:

```bash
cd src/golang
go build -o build/ipf-extractor ./cmd/ipf-extractor
```

### Permission Denied

```
Error: EACCES: permission denied
```

**Solution**: Make binary executable:

```bash
chmod +x src/golang/build/ipf-extractor
```

### Timeout Errors

```
Error: Command timed out
```

**Solution**: Increase timeout in `src/config.js`:

```javascript
EXECUTION_TIMEOUT: 1200000,  // 20 minutes
```

## License

MIT License - See LICENSE file for details.
